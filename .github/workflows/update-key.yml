name: 🔄 Actualizar Key Automática

on:
  schedule:
    - cron: '* * * * *'  # Ejecuta cada minuto
  workflow_dispatch:     # Permite ejecución manual

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 2   # Para evitar jobs largos

    steps:
      - name: 🛎️ Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para hacer push

      - name: 🌐 Obtener HTML de la página
        run: |
          curl -s "https://lilwero20.github.io/kesfagd/" > page.html
          echo "Página descargada $(ls -lh page.html)"

      - name: 🔍 Extraer key del HTML
        id: extract
        run: |
          KEY=$(grep -oP 'WERO-\w{12}' page.html | head -1)
          echo "Nueva key: $KEY"
          echo "KEY=${KEY}" >> $GITHUB_ENV

      - name: 💾 Comparar y actualizar key.txt
        run: |
          # Leer key actual
          if [ -f "key.txt" ]; then
            OLD_KEY=$(cat key.txt)
            echo "Key actual: $OLD_KEY"
          else
            OLD_KEY=""
            echo "No existe key.txt"
          fi

          # Comparar keys
          if [ "$OLD_KEY" != "$KEY" ]; then
            echo "$KEY" > key.txt
            echo "🔄 Actualizando key.txt a: $KEY"

            # Configurar Git
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"

            # Commit y push
            git add key.txt
            git commit -m "🔄 Key actualizada: $KEY"
            git push
            echo "✅ Key actualizada con éxito"
          else
            echo "⏩ Key sin cambios"
          fi
